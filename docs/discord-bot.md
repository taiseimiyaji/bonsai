了解。**サジェスト（候補表示）を効かせたい**なら、スラッシュコマンドの引数は **User 型**にするのが最適です。これなら入力欄でメンバー候補が出て、タップで選べます。

その前提で、仕様書を **コマンド仕様中心に差し替え**ます（列名は **「祠」「アトラク」** をそのまま使う）。

---

# 仕様書（改訂）：/atoraku-done と /hokora-done でシート更新

## 1. コマンド一覧

* `/atoraku-done`：対象ユーザーの **「アトラク」列** を「済」に更新
* `/hokora-done`：対象ユーザーの **「祠」列** を「済」に更新

※「未」に戻す要件は現時点では無し（必要なら別途 `/atoraku-undone` 等を追加）

---

## 2. コマンド入力仕様（サジェスト有効）

### 2.1 オプション定義（共通）

* `user1`（必須）

    * 型：**User**
* `user2`〜`user5`（任意）

    * 型：**User**

> User 型なので、Discord クライアント上で **メンバーサジェストが効く**（検索＆選択できる）

### 2.2 例

* `/atoraku-done user1:@らて user2:@リンダマン user3:@HalfMoon`
* `/hokora-done user1:@ぎん user2:@せら`

---

## 3. 更新仕様（シート：メンバー管理）

### 3.1 更新対象列

* `/atoraku-done` → 列名 **「アトラク」**
* `/hokora-done` → 列名 **「祠」**

### 3.2 更新値

* 対象セルに **「済」** をセット
  （既に「済」の場合はそのまま。空欄/他値なら「済」に上書き）

---

## 4. ユーザー特定ロジック（“サーバープロフィール名”基準）

User 型で受け取っても、更新は **表示名（サーバーニックネーム）ベース**で行う。

### 4.1 取得する表示名（優先順）

Discord interaction から、対象ユーザーごとに以下の順で “名前文字列” を作る：

1. **サーバーニックネーム**（guild nickname / displayName 相当）
2. なければ **グローバル表示名**
3. なければ **ユーザー名**

### 4.2 シート「名前」列との照合（完全一致→部分一致）

* 正規化（前後空白除去、連続空白の圧縮、括弧/記号を比較用に吸収）をした上で
* 「名前」列（例：`らて（らてらて）`）に対して

    1. 完全一致（エイリアス含む）
    2. 部分一致（エイリアス含む）

エイリアス抽出例：
`HalfMoon【つっきー】` → `HalfMoon`, `つっきー`
`らて（らてらて）` → `らて`, `らてらて`

### 4.3 曖昧一致（複数ヒット）時の挙動

* **更新しない**
* Discord返信で「候補が複数」だと返す

> ※User型で選べるようになるので、曖昧一致は激減しますが、シート側の表記揺れで起き得るため残します。

---

## 5. Discord応答仕様

* 受信後すぐ **defer（考え中）**（3秒制限対策）
* 更新後に followup で結果報告

返信フォーマット例：

* ✅ 更新成功：`アトラク：済 に更新 → らて, リンダマン`
* ⚠️ 未検出：`未検出 → 〇〇`
* ⚠️ 曖昧：`曖昧一致 → 〇〇（候補: A / B）`
* ❌ エラー：`更新に失敗しました（管理者ログ参照）`

---

## 6. 実装メモ（Cloud Run → Sheets）

* 列位置固定ではなく、**ヘッダー名「祠」「アトラク」**で列を特定する
* 1コマンドで最大5人を **バッチ更新**する（Sheets APIの更新回数を減らす）

---

## 7. 追加提案（任意だが強くおすすめ）

今の「名前照合」でも動くけど、将来の表記揺れを潰すために、シートに列を1つ追加すると安定します：

* `discord_user_id`（DiscordのユーザーID）

    * User型で取れるIDを保存しておけば、次回以降は **IDで一意**に引ける
    * 名前変更・ニックネーム変更に強くなる

（ただし、今回は「列名は祠とアトラク」とのことなので、これは“将来の改善案”扱い）

---
